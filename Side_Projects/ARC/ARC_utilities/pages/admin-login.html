<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login</title>
    <script>
      window.onload = () => {
        //cookie decode function
        const getCookie = (name) => {
          name += "=";
          let decodedCookie = decodeURIComponent(document.cookie);
          let values = decodedCookie.split(";");
          let valuesLen = values.length;
          for (let i = 0; i < valuesLen; i++) {
            let c = values[i];
            while (c.charAt(0) == " ") {
              c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
              return c.substring(name.length, c.length);
            }
          }
          return "";
        };
        let key = getCookie("admin_key");
        //check if there is an existing cookie
        if (key == "") {
          //if not prompt for a password and send to server
          let input = prompt("Password:");
          fetch("/admin-login", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "applicantion/json",
            },
            body: JSON.stringify({ input }),
          }).then((res) => {
            window.location.href = res.url;
          });
        } else {
          //send the existing key to the server
          fetch("/admin-key", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "applicantion/json",
            },
            body: JSON.stringify({ key }),
          }).then((res) => {
            //if the returned url is valid, redirect
            let url = new URL(res.url).searchParams;
            if (url.get("valid") === "true") {
              window.location.href = res.url;
            } else {
              //otherwise prompt for the password
              let input = prompt("Password:");
              fetch("/admin-login", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Accept: "applicantion/json",
                },
                body: JSON.stringify({ input }),
              }).then((res) => {
                window.location.href = res.url;
              });
            }
          });
        }
      };
    </script>
  </head>
</html>
